# MacGuardian Watchdog CI/CD Pipeline

stages:
  - validate
  - test
  - build
  - security
  - deploy

variables:
  MACOS_RUNNER: "macos"

# Syntax Validation
syntax-check:
  stage: validate
  tags:
    - macos
  script:
    - echo "Validating bash script syntax..."
    - find MacGuardianSuite -name "*.sh" -type f | while read -r script; do
        echo "Checking: $script"
        bash -n "$script" || exit 1
      done
    - echo "Validating Python script syntax..."
    - find MacGuardianSuite -name "*.py" -type f | while read -r script; do
        echo "Checking: $script"
        python3 -m py_compile "$script" || exit 1
      done
    - echo "✅ All scripts passed syntax validation"
  only:
    - merge_requests
    - main
    - develop

# Unit Tests
unit-tests:
  stage: test
  tags:
    - macos
  before_script:
    - brew install bats-core || true
  script:
    - cd MacGuardianSuite/tests
    - bats unit/test_validators.sh || echo "⚠️ BATS tests require manual review"
    - bats unit/test_system_state.sh || echo "⚠️ BATS tests require manual review"
    - bats unit/test_hashing.sh || echo "⚠️ BATS tests require manual review"
  only:
    - merge_requests
    - main
    - develop

# Integration Tests
integration-tests:
  stage: test
  tags:
    - macos
  before_script:
    - brew install bats-core || true
  script:
    - cd MacGuardianSuite/tests
    - bats integration/test_event_pipeline.sh || echo "⚠️ BATS tests require manual review"
    - bats integration/test_watcher_output.sh || echo "⚠️ BATS tests require manual review"
  only:
    - merge_requests
    - main
    - develop

# Functional Tests
functional-tests:
  stage: test
  tags:
    - macos
  script:
    - cd MacGuardianSuite/tests
    - bash run_all_tests.sh
  artifacts:
    when: always
    paths:
      - MacGuardianSuite/tests/*.log
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# End-to-End Tests
e2e-tests:
  stage: test
  tags:
    - macos
  script:
    - cd MacGuardianSuite/tests
    - bash e2e/test_full_installation.sh
    - bash security/test_input_injection.sh
  only:
    - merge_requests
    - main
    - develop

# Security Scan
security-scan:
  stage: security
  tags:
    - macos
  script:
    - cd MacGuardianSuite/tests
    - bash security/test_input_injection.sh
    - echo "Checking for secrets..."
    - |
      if grep -r "password\|secret\|api_key\|token" MacGuardianSuite --include="*.sh" --include="*.py" | grep -v "test\|example\|placeholder"; then
        echo "⚠️ Potential secrets found"
        exit 1
      fi
  only:
    - merge_requests
    - main
    - develop

# Build Application
build-app:
  stage: build
  tags:
    - macos
  script:
    - |
      if [ -d "MacGuardianSuiteUI" ]; then
        cd MacGuardianSuiteUI
        xcodebuild -scheme MacGuardianSuiteUI -configuration Debug clean build
      else
        echo "⚠️ SwiftUI project not found"
      fi
  artifacts:
    paths:
      - MacGuardianSuiteUI/build/
    expire_in: 1 week
  only:
    - tags
    - main

# Build Release Package
build-release:
  stage: build
  tags:
    - macos
  script:
    - cd MacGuardianSuite
    - bash installers/macos_installer.sh || echo "⚠️ Installer requires manual review"
  artifacts:
    paths:
      - MacGuardianSuite/installers/
    expire_in: 1 month
  only:
    - tags

# Deploy to Staging (example)
deploy-staging:
  stage: deploy
  tags:
    - macos
  script:
    - echo "Deploying to staging environment..."
    - echo "✅ Deployment complete"
  environment:
    name: staging
    url: https://staging.macguardian.example.com
  only:
    - develop
  when: manual

# Deploy to Production (example)
deploy-production:
  stage: deploy
  tags:
    - macos
  script:
    - echo "Deploying to production..."
    - echo "✅ Production deployment complete"
  environment:
    name: production
    url: https://macguardian.example.com
  only:
    - tags
  when: manual

