name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up environment
      run: |
        echo "MACOS_VERSION=$(sw_vers -productVersion)" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
    
    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
    
    - name: Make scripts executable
      run: |
        chmod +x mac_suite.sh
        chmod +x MacGuardianSuite/*.sh
        chmod +x MacGuardianSuite/*.py 2>/dev/null || true
    
    - name: Create release directory
      run: |
        mkdir -p release/MacGuardianSuite-${VERSION}
        cp -R MacGuardianSuite release/MacGuardianSuite-${VERSION}/
        cp mac_suite.sh release/MacGuardianSuite-${VERSION}/
        cp README.md LICENSE SECURITY.md PRIVACY.md release/MacGuardianSuite-${VERSION}/
        # Create install script
        cat > release/MacGuardianSuite-${VERSION}/install.sh <<'EOF'
#!/bin/bash
# MacGuardian Suite Installer
set -e

INSTALL_DIR="${INSTALL_DIR:-$HOME/MacGuardian}"
echo "Installing MacGuardian Suite to $INSTALL_DIR..."

mkdir -p "$INSTALL_DIR"
cp -R MacGuardianSuite "$INSTALL_DIR/"
cp mac_suite.sh "$INSTALL_DIR/"

chmod +x "$INSTALL_DIR"/*.sh
chmod +x "$INSTALL_DIR"/MacGuardianSuite/*.sh

echo "âœ… Installation complete!"
echo "Run: $INSTALL_DIR/mac_suite.sh"
EOF
        chmod +x release/MacGuardianSuite-${VERSION}/install.sh
      env:
        VERSION: ${{ steps.version.outputs.VERSION }}
    
    - name: Create tarball
      run: |
        cd release
        tar -czf MacGuardianSuite-${VERSION}-macos.tar.gz MacGuardianSuite-${VERSION}/
        shasum -a 256 MacGuardianSuite-${VERSION}-macos.tar.gz > MacGuardianSuite-${VERSION}-macos.tar.gz.sha256
        echo "TARBALL=MacGuardianSuite-${VERSION}-macos.tar.gz" >> $GITHUB_ENV
        echo "SHA256=$(cat MacGuardianSuite-${VERSION}-macos.tar.gz.sha256 | awk '{print $1}')" >> $GITHUB_ENV
      env:
        VERSION: ${{ steps.version.outputs.VERSION }}
    
    - name: Create zip archive
      run: |
        cd release
        zip -r MacGuardianSuite-${VERSION}-macos.zip MacGuardianSuite-${VERSION}/
        shasum -a 256 MacGuardianSuite-${VERSION}-macos.zip > MacGuardianSuite-${VERSION}-macos.zip.sha256
        echo "ZIPFILE=MacGuardianSuite-${VERSION}-macos.zip" >> $GITHUB_ENV
        echo "ZIP_SHA256=$(cat MacGuardianSuite-${VERSION}-macos.zip.sha256 | awk '{print $1}')" >> $GITHUB_ENV
      env:
        VERSION: ${{ steps.version.outputs.VERSION }}
    
    - name: Create package installer (optional)
      id: pkg
      run: |
        if command -v productbuild &> /dev/null; then
          cd release
          # Create distribution.xml for productbuild
          cat > distribution.xml <<EOF
<?xml version="1.0" encoding="utf-8"?>
<installer-gui-script minSpecVersion="1">
    <title>MacGuardian Suite ${VERSION}</title>
    <organization>com.macguardian</organization>
    <domains enable_localSystem="true"/>
    <options customize="never" require-scripts="false" rootVolumeOnly="false"/>
    <pkg-ref id="com.macguardian.suite"/>
    <pkg-ref id="com.macguardian.suite">
        <bundle-version>
            <bundle id="com.macguardian.suite" CFBundleVersion="${VERSION}"/>
        </bundle-version>
    </pkg-ref>
    <choices-outline>
        <line choice="com.macguardian.suite"/>
    </choices-outline>
    <choice id="com.macguardian.suite" visible="false">
        <pkg-ref id="com.macguardian.suite"/>
    </choice>
    <pkg-ref id="com.macguardian.suite" version="${VERSION}" onConclusion="none">MacGuardianSuite.pkg</pkg-ref>
</installer-gui-script>
EOF
          
          # Create component package
          pkgbuild --root MacGuardianSuite-${VERSION} \
                   --identifier com.macguardian.suite \
                   --version "${VERSION}" \
                   --install-location /usr/local/MacGuardian \
                   MacGuardianSuite.pkg
          
          # Create distribution package
          productbuild --distribution distribution.xml \
                      --package-path . \
                      --resources . \
                      MacGuardianSuite-${VERSION}.pkg
          
          shasum -a 256 MacGuardianSuite-${VERSION}.pkg > MacGuardianSuite-${VERSION}.pkg.sha256
          echo "PKG_FILE=MacGuardianSuite-${VERSION}.pkg" >> $GITHUB_ENV
          echo "PKG_SHA256=$(cat MacGuardianSuite-${VERSION}.pkg.sha256 | awk '{print $1}')" >> $GITHUB_ENV
          echo "PKG_CREATED=true" >> $GITHUB_ENV
        else
          echo "PKG_CREATED=false" >> $GITHUB_ENV
          echo "âš ï¸  productbuild not available, skipping .pkg creation"
        fi
      env:
        VERSION: ${{ steps.version.outputs.VERSION }}
    
    - name: Sign artifacts (if certificate available)
      if: env.PKG_CREATED == 'true'
      run: |
        # Check for signing certificate
        if [ -n "${{ secrets.MACOS_CERTIFICATE_P12 }}" ]; then
          echo "ðŸ” Signing certificate found, signing artifacts..."
          
          # Create keychain
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Import certificate
          echo "${{ secrets.MACOS_CERTIFICATE_P12 }}" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "${{ secrets.CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          
          # Sign .pkg
          if [ -f "release/MacGuardianSuite-${VERSION}.pkg" ]; then
            productsign --sign "Developer ID Installer: ${{ secrets.APPLE_DEVELOPER_NAME }}" \
                        release/MacGuardianSuite-${VERSION}.pkg \
                        release/MacGuardianSuite-${VERSION}-signed.pkg
            mv release/MacGuardianSuite-${VERSION}-signed.pkg release/MacGuardianSuite-${VERSION}.pkg
            echo "âœ… Package signed"
          fi
          
          # Cleanup
          rm -f certificate.p12
          security delete-keychain build.keychain
        else
          echo "âš ï¸  No signing certificate found, skipping code signing"
          echo "   To enable signing, add MACOS_CERTIFICATE_P12, KEYCHAIN_PASSWORD, CERTIFICATE_PASSWORD, and APPLE_DEVELOPER_NAME to GitHub Secrets"
        fi
      env:
        VERSION: ${{ steps.version.outputs.VERSION }}
        PKG_CREATED: ${{ env.PKG_CREATED }}
    
    - name: Create release notes
      id: release_notes
      run: |
        cat > release/RELEASE_NOTES.md <<EOF
# MacGuardian Suite ${VERSION}

## Installation

### Option 1: Tarball
\`\`\`bash
tar -xzf MacGuardianSuite-${VERSION}-macos.tar.gz
cd MacGuardianSuite-${VERSION}
./install.sh
\`\`\`

### Option 2: Zip Archive
\`\`\`bash
unzip MacGuardianSuite-${VERSION}-macos.zip
cd MacGuardianSuite-${VERSION}
./install.sh
\`\`\`

### Option 3: Package Installer (if available)
Double-click \`MacGuardianSuite-${VERSION}.pkg\` and follow the installer.

## Checksums

**Tarball SHA-256:**
\`\`\`
${SHA256}
\`\`\`

**Zip SHA-256:**
\`\`\`
${ZIP_SHA256}
\`\`\`

$([ "$PKG_CREATED" = "true" ] && echo "**Package SHA-256:**\n\`\`\`\n${PKG_SHA256}\n\`\`\`" || echo "")

## What's New

See [CHANGELOG.md](CHANGELOG.md) for detailed changes.

## Documentation

- [README.md](README.md) - Getting started
- [SECURITY.md](SECURITY.md) - Security policy
- [PRIVACY.md](PRIVACY.md) - Privacy policy

## Support

- GitHub Issues: https://github.com/${{ github.repository }}/issues
- Documentation: See README.md

---
Built on: ${BUILD_DATE}
macOS: ${MACOS_VERSION}
EOF
        echo "RELEASE_NOTES=release/RELEASE_NOTES.md" >> $GITHUB_ENV
      env:
        VERSION: ${{ steps.version.outputs.VERSION }}
        SHA256: ${{ env.SHA256 }}
        ZIP_SHA256: ${{ env.ZIP_SHA256 }}
        PKG_SHA256: ${{ env.PKG_SHA256 }}
        PKG_CREATED: ${{ env.PKG_CREATED }}
        BUILD_DATE: ${{ env.BUILD_DATE }}
        MACOS_VERSION: ${{ env.MACOS_VERSION }}
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: MacGuardian Suite ${{ steps.version.outputs.VERSION }}
        body_path: release/RELEASE_NOTES.md
        files: |
          release/MacGuardianSuite-${{ steps.version.outputs.VERSION }}-macos.tar.gz
          release/MacGuardianSuite-${{ steps.version.outputs.VERSION }}-macos.tar.gz.sha256
          release/MacGuardianSuite-${{ steps.version.outputs.VERSION }}-macos.zip
          release/MacGuardianSuite-${{ steps.version.outputs.VERSION }}-macos.zip.sha256
          release/MacGuardianSuite-${{ steps.version.outputs.VERSION }}.pkg
          release/MacGuardianSuite-${{ steps.version.outputs.VERSION }}.pkg.sha256
        draft: false
        prerelease: ${{ contains(steps.version.outputs.VERSION, '-') || contains(steps.version.outputs.VERSION, 'alpha') || contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

