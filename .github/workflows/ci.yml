name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-test:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Make scripts executable
      run: |
        chmod +x mac_suite.sh
        chmod +x MacGuardianSuite/*.sh
        chmod +x MacGuardianSuite/*.py 2>/dev/null || true
    
    - name: ShellCheck (if available)
      run: |
        if command -v shellcheck &> /dev/null; then
          echo "Running ShellCheck..."
          find MacGuardianSuite -name "*.sh" -exec shellcheck {} \; || true
        else
          echo "⚠️  ShellCheck not installed, skipping"
          echo "   Install with: brew install shellcheck"
        fi
      continue-on-error: true
    
    - name: Python syntax check
      run: |
        echo "Checking Python syntax..."
        python3 -m py_compile MacGuardianSuite/*.py 2>/dev/null || true
        echo "✅ Python syntax check complete"
      continue-on-error: true
    
    - name: Verify script syntax
      run: |
        echo "Verifying bash script syntax..."
        for script in MacGuardianSuite/*.sh; do
          if [ -f "$script" ]; then
            bash -n "$script" || echo "⚠️  Syntax error in $script"
          fi
        done
        bash -n mac_suite.sh || echo "⚠️  Syntax error in mac_suite.sh"
        echo "✅ Syntax check complete"
      continue-on-error: true
    
    - name: Check for required files
      run: |
        echo "Checking for required files..."
        required_files=(
          "README.md"
          "LICENSE"
          "SECURITY.md"
          "PRIVACY.md"
          "mac_suite.sh"
          "MacGuardianSuite/config.sh"
          "MacGuardianSuite/utils.sh"
        )
        missing=0
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ Missing: $file"
            missing=$((missing + 1))
          else
            echo "✅ Found: $file"
          fi
        done
        if [ $missing -gt 0 ]; then
          echo "❌ $missing required file(s) missing"
          exit 1
        fi
        echo "✅ All required files present"
    
    - name: Test dry-run mode
      run: |
        echo "Testing dry-run mode..."
        # Test that remediation defaults to dry-run
        if grep -q "DRY_RUN=true" MacGuardianSuite/mac_remediation.sh; then
          echo "✅ Remediation defaults to dry-run"
        else
          echo "⚠️  Remediation may not default to dry-run"
        fi
      continue-on-error: true

